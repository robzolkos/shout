#!/bin/bash
#
# shout - Simple speech-to-text for Wayland/Hyprland
#
# Press keybind once to start recording, again to stop and transcribe.
# Text is automatically typed into the focused application.

STATE_DIR="${XDG_RUNTIME_DIR:-/tmp}"
STATE_FILE="$STATE_DIR/shout.pid"
AUDIO_FILE="$STATE_DIR/shout.wav"

WHISPER_CLI="whisper-cli"
WHISPER_MODEL="/usr/share/whisper.cpp-model-tiny.en/ggml-tiny.en.bin"

recording="false"
if [[ -f "$STATE_FILE" ]]; then
    pid="$(<"$STATE_FILE")"
    if [[ "$pid" =~ ^[0-9]+$ ]] && kill -0 "$pid" 2>/dev/null; then
        if [[ "$(ps -p "$pid" -o comm=)" == "pw-record" ]]; then
            recording="true"
        fi
    else
        rm -f "$STATE_FILE"
    fi
fi

if [[ "$recording" == "true" ]]; then
    # Stop recording
    kill -- "$pid" 2>/dev/null
    rm -f "$STATE_FILE"

    notify-send -t 1000 -h string:x-canonical-private-synchronous:shout "shout" "Processing..."

    # Transcribe (file is positional arg, strip leading whitespace)
    TEXT=$("$WHISPER_CLI" -m "$WHISPER_MODEL" --no-timestamps "$AUDIO_FILE" 2>/dev/null | grep -v '^\[' | sed 's/^[[:space:]]*//' | tr -d '\n')

    # Type it out and press Enter
    if [[ -n "$TEXT" ]]; then
        wtype "$TEXT"
        wtype -k Return
    else
        notify-send -t 2000 "shout" "No speech detected"
    fi

    rm -f "$AUDIO_FILE"
else
    # Start recording
    notify-send -t 0 -h string:x-canonical-private-synchronous:shout "shout" "Listening..."
    pw-record --rate=16000 --channels=1 --format=s16 "$AUDIO_FILE" &
    printf '%s\n' "$!" > "$STATE_FILE"
fi
